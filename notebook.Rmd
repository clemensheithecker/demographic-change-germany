---
title: "Demographic Change in Germanyâ€”A Case Study"
author: "Clemens S. Heithecker"
date: "2 July 2021"
output:
  html_document:
    df_print: paged
    theme: readable
    highlight: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  # centers figures in the document
  fig.align = 'center',
  # display source code in the document
  echo = TRUE,
  # preserve messages emitted
  message = FALSE,
  # preserve warnings emitted
  warning = FALSE
)
```

A low birth rate and rising life expectancy are fueling demographic change in Germany. These trends pose economic challenges such as a dwindling labor force and the underfunding of social security systems. As a result, lawmakers must re-evaluate existing public policies and design new solutions. This case study provides data visualizations supporting the exploration and evaluation of policy options to solve these demographic problems.

The project's source files as well as references are published on the [project's GitHub repository](https://github.com/clemensheithecker/demographic-change-germany).

## Libraries

```{r libraries}
library(here)
library(readxl)
library(tidyverse)
```

## Global Styles and Colors

I created two color pallets as lists which I referenced when styling the graphs.

```{r}
colors_primary = list(
  very_light_blue = "#DBEAFE",
  light_blue = "#93C5FD",
  blue = "#3B82F6",
  dark_blue = "#1D4ED8",
  very_dark_blue = "#1E3A8A",
  very_light_gray = "#E4E4E7",
  light_gray = "#A1A1AA",
  dark_gray = "#52525B"
)

colors_secondary = list(
  title = "#18181B",
  text = "#3F3F46",
  line = "#D4D4D4",
  caption = "#71717A"
)
```

## Total Fertility Rate in Germany

A visualization of the average live births per woman over time. The data is grouped by region: Federal Republic of Germany, former territory of the Federal Republic, former territory of East Germany.

### Reading and Cleaning Data

Reading the .csv file with semicolon delimeter using readr's *read_delim* function.

```{r}
fertility_rate <-
  read_delim(
    file = here("data", "completed-cohort-fertility.csv"),
    delim = ";",
    escape_double = FALSE,
    col_names = c("Year",
                  "Germany",
                  "Old Federal States",
                  "New Federal States"),
    col_types = "innn",
    locale = locale(
      decimal_mark = ".",
      grouping_mark = ",",
      encoding = "UTF-8"
    ),
    trim_ws = TRUE,
    skip = 1
  )

tail(fertility_rate)
```

Reshape data frame to long format. Having a column for every variable and a row for every observation makes it easier to visualize the data using *ggplot2*.

```{r}
fertility_rate_long <- fertility_rate %>%
  gather(key = "Country/Region",
         value = "Total Fertility Rate", -"Year")

tail(fertility_rate_long)
```

Change the factor order. This changes the order of the labels in the legend of
the plot. Additionally, give factors more descriptive names.

```{r}
# change factor order
fertility_rate_long$`Country/Region` <-
  factor(
    fertility_rate_long$`Country/Region`,
    c("New Federal States",
      "Old Federal States",
      "Germany")
  )

# rename factors
fertility_rate_long$`Country/Region` <- recode(
  fertility_rate_long$`Country/Region`,
  `New Federal States` = "New Federal States (East Germany until 1989)",
  `Old Federal States`  = "Old Federal States (West Germany until 1989)",
  `Germany` = "Germany"
)

levels(fertility_rate_long$`Country/Region`)
```


### Plot Data

Plotting the data as a line plot.

```{r}
ggplot(
  data = fertility_rate_long,
  mapping = aes(x = Year,
                y = `Total Fertility Rate`,
                color = `Country/Region`)
) +
  geom_line(size = 2) +
  # starting y-axis from y=0
  expand_limits(y = 0) +
  # setting custom color scale
  scale_color_manual(
    values = c(
      colors_primary$very_light_gray,
      colors_primary$dark_gray,
      colors_primary$blue
    )
  ) +
  # setting x-axis scale from 1950 to 2020 in 10-year intervals
  scale_x_continuous(breaks = seq(from = 1950, to = 2020, by = 10)) +
  # setting y-axis scale
  scale_y_continuous(breaks = seq(from = 0, to = 2.5, by = 0.5)) +
  labs(
    title = "Fig. 1: Total Fertility Rate in Germany",
    subtitle = "Children per woman by calendar year",
    x = element_blank(),
    y = element_blank(),
    caption = "Federal Statistical Office (Destatis), 2021"
  ) +
  # reverse order of legend
  guides(color = guide_legend(reverse = TRUE)) +
  # Theme And Styles
  theme_minimal() +
  theme(
    axis.line = element_line(
      color = colors_secondary$line,
      size = 1,
      linetype = "solid"
    ),
    axis.text = element_text(color = colors_secondary$text,
                             size = rel(1.4)),
    legend.direction = "vertical",
    legend.justification = "left",
    legend.position = "bottom",
    legend.text = element_text(color = colors_secondary$text,
                               size = rel(1.4)),
    legend.title = element_blank(),
    panel.grid = element_line(color = colors_secondary$line),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    plot.caption = element_text(color = colors_secondary$caption,
                                size = rel(1.4)),
    plot.subtitle = element_text(color = colors_secondary$title,
                                 size = rel(1.6)),
    plot.title = element_text(
      color = colors_secondary$title,
      size = rel(1.8),
      face = "bold",
      family = "serif"
    )
  )
```

Save figure as .png file.

```{r}
ggsave(
  "figures/plot_1_fertility_rate.png",
  width = 24,
  height = 18,
  units = "cm",
  dpi = "retina",
  bg = "white"
)
```

## At-Risk-of-Poverty Rate of Families

A visual comparison of the at-risk-of-poverty rate by household type. The rate is measured against the federal median income.

### Reading and Cleaning Data

Reading the .xlsx file readxl's *read_excel* function.

```{r}
poverty_risk_rate <-
  read_excel(
    "data/Armutsgefaehrdungsquote-nach-Haushaltstyp.xlsx",
    # translate column names from German to English
    col_names = c(
      "Year",
      "One-Person Household",
      "Two Adults Without Children",
      "Other Household Without Children",
      "One Adult With Children",
      "Two Adults With One Child",
      "Two Adults With Two Children",
      "Two Adults With Three Or More Children",
      "Other Household With Children"
    ),
    col_types = rep("numeric", times = 9),
    skip = 3,
    n_max = 15
  )
```

Subset data to select relevant columns of households with children and the most recent year of the dataset, 2019.

```{r}
poverty_risk_rate <- poverty_risk_rate %>%
  filter(Year == 2019) %>%
  select(
    `Year`,
    `One Adult With Children`,
    `Two Adults With One Child`,
    `Two Adults With Two Children`,
    `Two Adults With Three Or More Children`,
    `Other Household With Children`
  )

str(poverty_risk_rate)
```

Reshape data frame to long format.

```{r}
poverty_risk_rate_long <- poverty_risk_rate %>%
  gather(key = "Household Type",
         value = "Poverty Risk Rate", -"Year")

poverty_risk_rate_long
```

Change the factor order. This changes the order of the labels in the legend of
the plot.

```{r}
poverty_risk_rate_long$`Household Type` <-
  factor(
    poverty_risk_rate_long$`Household Type`,
    c(
      "Other Household With Children",
      "One Adult With Children",
      "Two Adults With Three Or More Children",
      "Two Adults With Two Children",
      "Two Adults With One Child"
    )
  )

levels(poverty_risk_rate_long$`Household Type`)
```

### Plot Data

Plotting the data as a bar plot.

```{r, fig.width=9.5}
ggplot(data = poverty_risk_rate_long,
       mapping = aes(x = `Poverty Risk Rate`,
                     y = `Household Type`)) +
  geom_col(fill = colors_primary$dark_gray) +
  # format x-axis scale as percentage
  scale_x_continuous(
    labels = function(x)
      paste0(x, "%")
  ) +
  labs(
    title = "Fig. 2: At-Risk-Of-Poverty Rate Of Families",
    subtitle = "Measured by median income",
    x = element_blank(),
    y = element_blank(),
    caption = "Federal Statistical Office, micro-census"
  ) +
  theme_minimal() +
  theme(
    axis.line = element_line(
      color = colors_secondary$line,
      size = 1,
      linetype = "solid"
    ),
    axis.text = element_text(color = colors_secondary$text,
                             size = rel(1.4)),
    panel.grid = element_line(color = colors_secondary$line),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    plot.caption = element_text(color = colors_secondary$caption,
                                size = rel(1.4)),
    plot.subtitle = element_text(color = colors_secondary$title,
                                 size = rel(1.6)),
    plot.title = element_text(
      color = colors_secondary$title,
      size = rel(1.8),
      face = "bold",
      family = "serif"
    )
  )
```

Save figure as .png file.

```{r}
ggsave(
  "figures/plot_2_poverty_risk_rate.png",
  width = 24,
  height = 18,
  units = "cm",
  dpi = "retina",
  bg = "white"
)
```
